<!DOCTYPE html>
<html lang="en" style="user-select: none;">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabby</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <style>
      body, html, canvas {
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        outline: none;
      }
    </style>
  </head>
  <body style="margin: 0; width: 100vw; height: 100vh; background: black; pointer-events:none;overflow: hidden;user-select: none;">
        <canvas style="display: block;" id="renderMan" ></canvas>
	<script>
        const getQueryParam = (paramName) => new URL(window.location.href).searchParams.get(paramName);
        const PARTICLE_COUNT = ~~getQueryParam('count') || 1_000_000;
        const WORKER_COUNT = navigator.hardwareConcurrency - 1;
        const WORKER_CHUNK_SIZE = Math.floor(PARTICLE_COUNT / WORKER_COUNT);
        const workerPool = [];
        let activeWorkers = 0;
        
        const canvas = document.getElementById('renderMan');
        const context = canvas.getContext('2d');
        let width = window.innerWidth;
        let height = window.innerHeight;
        let backbuffer = new ImageData(window.innerWidth, window.innerHeight);
        let particleGridA, particleGridB, activeParticleGrid;

        const particleStride = 6; // 4 floats x,y,dx,dy,sx,sy;
        const particleByteStride = particleStride*4; // 4 bytes per float
        const sabViewParticles = new Float32Array(new SharedArrayBuffer(PARTICLE_COUNT * particleByteStride));
        // dt + screen width + screen height + touch count + mouse x + mouse y 
        const sabViewSimData = new Float32Array(new SharedArrayBuffer(4*64));

        
        // windowing init
       // windowing init
       function resize() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          sabViewSimData[1] = canvas.width;
          sabViewSimData[2] = canvas.height;
          backbuffer = new ImageData(canvas.width, canvas.height);
          particleGridA = new Uint8Array(new SharedArrayBuffer(width*height));
          particleGridB = new Uint8Array(new SharedArrayBuffer(width*height));
          activeParticleGrid = particleGridA;
          for(let i = 0;i<PARTICLE_COUNT;i++) {
            sabViewParticles[i*particleStride] = Math.random() * width;
            sabViewParticles[i*particleStride+1] = Math.random() * height;
            sabViewParticles[i*particleStride+2] = (Math.random()*2-1)*30;
            sabViewParticles[i*particleStride+3] = (Math.random()*2-1)*30;
            sabViewParticles[i*particleStride+4] = sabViewParticles[i*particleStride];
            sabViewParticles[i*particleStride+5] = sabViewParticles[i*particleStride+1];
          }
          if (workerPool.length <= 0) return;
          for(let i = 0;i< WORKER_COUNT;i++) {
            const worker = workerPool[i];
            worker.postMessage({
              id: i,
              sabViewParticles,
              sabViewSimData,
              particleOffsetStart: WORKER_CHUNK_SIZE*i,
              particleOffsetEnd:  WORKER_CHUNK_SIZE*i + WORKER_CHUNK_SIZE,
              particleStride,
              particleGridA,
              particleGridB
            });
          }
        }
        resize();
        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', e => {
          sabViewSimData[4] = e.clientX;
          sabViewSimData[5] = e.clientY;
        });
        window.addEventListener('mousedown', e => {
          sabViewSimData[3] = 1;
        });
        window.addEventListener('mouseup', e => {
          sabViewSimData[3] = 0;
        });
        window.addEventListener('touchmove', e => {
          e.preventDefault();
          sabViewSimData[3] = e.targetTouches.length;
          for(let i = 0;i < e.targetTouches.length;i++) {
            const touch = e.targetTouches[i];
            sabViewSimData[i*2+4] = touch.clientX;
            sabViewSimData[i*2+4+1] = touch.clientY;
          }
        });
        window.addEventListener('touchstart', e => {
          e.preventDefault();
          sabViewSimData[3] = e.targetTouches.length;
          for(let i = 0;i < e.targetTouches.length;i++) {
            const touch = e.targetTouches[i];
            sabViewSimData[i*2+4] = touch.clientX;
            sabViewSimData[i*2+4+1] = touch.clientY;
          }
        });
        window.addEventListener('touchend', (e) => {
          e.preventDefault();
          sabViewSimData[3] = 0;
        });
        window.addEventListener('touchcancel', (e) => {
          e.preventDefault();
          sabViewSimData[3] = 0;
        });

        //setup workers
        activeWorkers = WORKER_COUNT;
        for(let i = 0;i< WORKER_COUNT;i++) {
          const worker = new Worker('./worker.js');
          worker.addEventListener('message', onWorkerMessage);
          workerPool.push(worker);
          worker.postMessage({
            id: i,
            sabViewParticles,
            sabViewSimData,
            particleOffsetStart: WORKER_CHUNK_SIZE*i,
            particleOffsetEnd:  WORKER_CHUNK_SIZE*i + WORKER_CHUNK_SIZE,
            particleStride,
            particleGridA,
            particleGridB,
          });
        }

      //init particles
      for(let i = 0;i < PARTICLE_COUNT;i++) {
        sabViewParticles[i*particleStride] = Math.random() * width;
        sabViewParticles[i*particleStride+1] = Math.random() * height;
        sabViewParticles[i*particleStride+2] = (Math.random()*2-1)*30;
        sabViewParticles[i*particleStride+3] = (Math.random()*2-1)*30;
        sabViewParticles[i*particleStride+4] = sabViewParticles[i*particleStride];
        sabViewParticles[i*particleStride+5] = sabViewParticles[i*particleStride+1];
      }

      function onWorkerMessage() {
        activeWorkers--;
        if (activeWorkers !== 0) {
          return;
        }

        requestAnimationFrame(runSimulation);
      };

      let lastTime = 1;
      function runSimulation(currentTime) {
        const dt = Math.min(0.1, (currentTime - lastTime) / 1000);
        lastTime = currentTime;
        sabViewSimData[0] = dt;
        activeWorkers = WORKER_COUNT;
        workerPool.forEach((worker, i) => {
          worker.postMessage({});
        });
        activeParticleGrid = activeParticleGrid === particleGridA ? particleGridB : particleGridA;
        render(activeParticleGrid);
      }

      function render(grid) {
        const width = canvas.width;
        const height = canvas.height;
        const pixels = backbuffer.data;
        pixels.fill(0);
        for (let i = 0; i < width * height; i++) {
          const particleCount = grid[i];
          const y = Math.floor(i / width);
          const x = i % width;
          const rx = x / width;
          const ry = y / height;
          pixels[i * 4] = (25 + 35 * rx)*particleCount;
          pixels[i * 4 + 1] = (25 + 35 * ry)*particleCount;
          pixels[i * 4 + 2] = (25 + 35 * (1-ry))*particleCount;
          pixels[i * 4 + 3] = 255;
        }
        grid.fill(0);

        context.putImageData(backbuffer, 0, 0);
      }
    </script>
  </body>
</html>